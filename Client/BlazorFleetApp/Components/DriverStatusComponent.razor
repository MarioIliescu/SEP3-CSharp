@using ApiContracts.Dtos.Driver
@implements IAsyncDisposable
@inject NavigationManager NavMgr
@using Microsoft.AspNetCore.Components.Authorization
@using ApiContracts.Enums
@inject IDriverService DriverService
@inject AuthenticationStateProvider AuthStateProvider
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Job
@using Microsoft.AspNetCore.SignalR.Client
@if (driver != null)
{
    <div>
        @if (userRole == UserRole.Driver)
        {
            <select class="driver-status"
                    style="background-image: url('@GetStatusImage()');"
                    @bind="status">
                @foreach (DriverStatus s in Enum.GetValues<DriverStatus>())
                {
                    <option value="@s">@s</option>
                }
            </select>
        }
        @if (userRole == UserRole.Dispatcher)
        {
            <div class="driver-status-text"
                 style="background-image: url('@GetStatusImage()');">
                <span>@_status</span>
            </div>
        }
    </div>
}
else
{
    <div><p>Loading driver...</p></div>
}


@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public DriverDto? DriverDto { get; set; }
    [Inject] private IJSRuntime JS { get; set; }
    private HubConnection? hubConnection;
    private int userId;
    private UserRole? userRole;
    private DriverDto? driver;
    private DriverStatus _status = DriverStatus.Off_duty;
    private IJSObjectReference? module;
    private DriverStatus status
    {
        get => _status;
        set
        {
            if (driver == null || !_hubInitialized) return;
            if (_status != value)
            {
                _status = value;
                _ = ChangeStatusAsync(value);
            }
        }
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadDriverAsync();
    }
    private bool _hubInitialized;

    private async Task SetupHubAsync()
    {
        if (_hubInitialized)
            return;

        if (hubConnection != null)
        {
            try
            {
                await hubConnection.StopAsync();
                await hubConnection.DisposeAsync();
            }
            catch { }
        }

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavMgr.ToAbsoluteUri("/fleethub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<FleetEventType>("FleetEvent", async eventType =>
        {
            await InvokeAsync(async () =>
            {
                if (eventType == FleetEventType.DriverStatusChanged
                    || eventType == FleetEventType.DriversUpdated)
                {
                    await RefreshDriverAsync();
                    await InvokeAsync(StateHasChanged);
                }
            });
        });

        await hubConnection.StartAsync();

        _hubInitialized = true;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await SetupHubAsync();
            if (driver != null)
                await RefreshDriverAsync();
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/DriverStatusComponent.razor.js");
        }
    }



    private async Task LoadDriverAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var roleClaim = user.FindFirst("Role")?.Value;
            if (!string.IsNullOrEmpty(roleClaim) &&
                Enum.TryParse<UserRole>(roleClaim, true, out var parsedRole))
            {
                userRole = parsedRole;
            }

            int id = userRole == UserRole.Driver
                ? int.Parse(user.FindFirst("Id")?.Value ?? "0")
                : InitialDriverId ?? 0;

            if (id != 0)
            {
                driver = await DriverService.GetSingleAsync(id);
                if (driver != null)
                    _status = driver.Status;
            }
        }

        await InvokeAsync(StateHasChanged);
    }


    private string GetStatusImage()
    {
        if (driver == null)
        {
            return "/images/reddot.png";
        }

        return driver.Status switch
        {
            DriverStatus.Available => "/images/greendot.png",
            DriverStatus.Busy => "/images/yellowdot.png",
            _ => "/images/reddot.png"
        };
    }

    private async Task ChangeStatusAsync(DriverStatus newStatus)
    {
        if (driver == null || driver.Status == newStatus || !_hubInitialized)
            return;
        driver = driver with { Status = newStatus };
        await DriverService.UpdateAsync(driver);

        if (hubConnection != null)
            await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.DriverStatusChanged);

        _status = newStatus;

        if (JS != null)
            await JS.InvokeVoidAsync("blurActiveElement");

        await InvokeAsync(StateHasChanged);
    }




    private async Task RefreshDriverAsync()
    {
        if (driver != null)
        {
            driver = await DriverService.GetSingleAsync(driver.Id);

            if (driver != null)
                _status = driver.Status;
        }

        await InvokeAsync(StateHasChanged);
    }


    private bool _disposed;

    public async ValueTask DisposeAsync()
    {
        if (_disposed)
            return;

        _disposed = true;
        _hubInitialized = false;

        if (hubConnection != null)
        {
            try
            {
                await hubConnection.StopAsync();
                await hubConnection.DisposeAsync();
            }
            catch { }
        }

        if (module != null)
        {
            try { await module.DisposeAsync(); } catch { }
        }
    }


}