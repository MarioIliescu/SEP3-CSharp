@using ApiContracts.Dtos.Driver
@using ApiContracts.Enums
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Hubs
@using Microsoft.AspNetCore.Components.Authorization
@inject FleetHubClient FleetHub
@inject IDriverService DriverService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

@if (driver != null)
{
    <div>
        @if (userRole == UserRole.Driver)
        {
            <select class="driver-status"
                    disabled="@isUpdating"
                    style="background-image: url('@GetStatusImage()');"
                    @bind="@statusValue">
                @foreach (DriverStatus s in Enum.GetValues<DriverStatus>())
                {
                    <option value="@s">@s</option>
                }
            </select>
        }
        @if (userRole == UserRole.Dispatcher)
        {
            <div class="driver-status-text"
                 style="background-image: url('@GetStatusImage()');">
                <span>@_status</span>
            </div>
        }
    </div>
}
else
{
    <div><p>Loading driver...</p></div>
}

@code {
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public DriverDto? DriverDto { get; set; }

    private DriverDto? driver;
    private DriverStatus statusValueBacking;
    private DriverStatus statusValue
    {
        get => statusValueBacking;
        set
        {
            if (statusValueBacking != value)
            {
                statusValueBacking = value;
                _ = ChangeStatusAsync(value);
            }
        }
    }

    private DriverStatus _status;
    private UserRole? userRole;
    private bool isUpdating;
    private bool _disposed;
    private bool _subscribed;
    private bool _joinedGroup;

    protected override async Task OnInitializedAsync()
    {
        await FleetHub.StartAsync();
        await LoadDriverAsync();

        if (driver != null && !_joinedGroup)
        {
            await FleetHub.JoinGroupAsync(driver.Id.ToString());
            _joinedGroup = true;
        }

        if (!_subscribed)
        {
            FleetHub.OnFleetEvent += HandleFleetEvent;
            _subscribed = true;
        }
    }

    private async Task LoadDriverAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var roleClaim = user.FindFirst("Role")?.Value;
            if (!string.IsNullOrEmpty(roleClaim) &&
                Enum.TryParse<UserRole>(roleClaim, true, out var parsedRole))
            {
                userRole = parsedRole;
            }

            int id = userRole == UserRole.Driver
                ? int.Parse(user.FindFirst("Id")?.Value ?? "0")
                : InitialDriverId ?? 0;

            if (id != 0)
            {
                driver = await DriverService.GetSingleAsync(id);
                if (driver != null)
                {
                    _status = driver.Status;
                    statusValue = driver.Status;
                }
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private string GetStatusImage() =>
        driver?.Status switch
        {
            DriverStatus.Available => "/images/greendot.png",
            DriverStatus.Busy => "/images/yellowdot.png",
            _ => "/images/reddot.png"
        };

    private async Task ChangeStatusAsync(DriverStatus newStatus)
    {
        if (driver == null || driver.Status == newStatus || isUpdating)
            return;

        isUpdating = true;
        driver = driver with { Status = newStatus };
        await DriverService.UpdateAsync(driver);

        if (driver != null)
            await FleetHub.NotifyGroupAsync(driver.Id.ToString(), FleetEventType.DriverStatusChanged);

        _status = newStatus;
        statusValue = newStatus;

        isUpdating = false;
        await JS.InvokeVoidAsync("blurActiveElement");
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshDriverAsync()
    {
        if (_disposed || driver == null) return;

        var latest = await DriverService.GetSingleAsync(driver.Id);
        if (latest != null)
        {
            driver = latest;
            _status = driver.Status;
            statusValue = driver.Status;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleFleetEvent(FleetEventType evt)
    {
        if (_disposed) return;

        if (driver != null &&
            (evt == FleetEventType.DriverStatusChanged || evt == FleetEventType.DriversUpdated))
        {
            if (!isUpdating)
                await RefreshDriverAsync();
        }
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;

        if (_subscribed)
        {
            FleetHub.OnFleetEvent -= HandleFleetEvent;
            _subscribed = false;
        }

        if (_joinedGroup && driver != null)
        {
            await FleetHub.LeaveGroupAsync(driver.Id.ToString());
            _joinedGroup = false;
        }
    }
}
