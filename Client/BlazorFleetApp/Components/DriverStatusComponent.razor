@using ApiContracts.Dtos.Driver
@implements IAsyncDisposable
@inject NavigationManager NavMgr
@using Microsoft.AspNetCore.Components.Authorization
@using ApiContracts.Enums
@inject IDriverService DriverService
@inject AuthenticationStateProvider AuthStateProvider
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Job
@using Microsoft.AspNetCore.SignalR.Client
@if (driver != null)
{
    <div>
        @if (userRole == UserRole.Driver)
        {
            <select class="driver-status"
                    style="background-image: url('@GetStatusImage()');"
                    @bind="status">
                @foreach (DriverStatus s in Enum.GetValues<DriverStatus>())
                {
                    <option value="@s">@s</option>
                }
            </select>
        }
        @if (userRole == UserRole.Dispatcher)
        {
            <div class="driver-status-text"
                 style="background-image: url('@GetStatusImage()');">
                <span>@_status</span>
            </div>
        }
    </div>
}
else
{
    <div><p>Loading driver...</p></div>
}


@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public DriverDto? DriverDto { get; set; }
    [Inject] private IJSRuntime JS { get; set; }
    private HubConnection? hubConnection;
    private int userId;
    private UserRole? userRole;
    private DriverDto? driver;
    private DriverStatus _status = DriverStatus.Off_duty;
    private IJSObjectReference? module;

    private DriverStatus status
    {
        get => _status;
        set
        {
            if (_status != value)
            {
                _status = value;
                _ = ChangeStatusAsync(value); // fire-and-forget
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDriverAsync();
        // Initialize hub connection
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavMgr.ToAbsoluteUri("/fleethub"))
            .WithAutomaticReconnect()
            .Build();

        // Subscribe to events
        hubConnection.On<FleetEventType>("FleetEvent", (eventType) =>
        {
            return InvokeAsync(async () =>
            {
                if (eventType is FleetEventType.DriverStatusChanged
                    or FleetEventType.DriversUpdated
                   )
                {
                    await RefreshDriverAsync();
                }
            });
        });
        await hubConnection.StartAsync();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./Components/DriverStatusComponent.razor.js"
            );
        }
    }

    private async Task LoadDriverAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var roleClaim = user.FindFirst("Role")?.Value;
            if (!string.IsNullOrEmpty(roleClaim) &&
                Enum.TryParse<UserRole>(roleClaim, true, out var parsedRole))
            {
                userRole = parsedRole;
            }

            if (userRole == UserRole.Driver)
            {
                var idClaim = user.FindFirst("Id")?.Value;
                if (!string.IsNullOrEmpty(idClaim))
                    userId = int.Parse(idClaim);

                driver = await DriverService.GetSingleAsync(userId);
                if (driver != null) _status = driver.Status;
            }
            else if (userRole == UserRole.Dispatcher && InitialDriverId.HasValue)
            {
                driver = await DriverService.GetSingleAsync(InitialDriverId.Value);
                if (driver != null) _status = driver.Status;
            }
        }
    }
    private string GetStatusImage()
    {
        if (driver == null)
        {
            return "/images/reddot.png";
        }

        return driver.Status switch
        {
            DriverStatus.Available => "/images/greendot.png",
            DriverStatus.Busy => "/images/yellowdot.png",
            _ => "/images/reddot.png"
        };
    }

    private async Task ChangeStatusAsync(DriverStatus newStatus)
    {
        if (driver == null) return;

        driver = driver with { Status = newStatus };
        await DriverService.UpdateAsync(driver);

        if (hubConnection != null)
        {
            await hubConnection.InvokeAsync(
                "NotifyEvent",
                FleetEventType.DriverStatusChanged
            );
        }

        _status = newStatus;
        await JS.InvokeVoidAsync("blurActiveElement");
        StateHasChanged();
    }

    private async Task RefreshDriverAsync()
    {
        if (driver != null)
        {
            driver = await DriverService.GetSingleAsync(driver.Id);

            if (driver != null)
                _status = driver.Status;
        }

        await InvokeAsync(StateHasChanged);
    }


    private bool _disposed;

    public async ValueTask DisposeAsync()
    {
        if (_disposed)
            return;

        _disposed = true;

        if (hubConnection is null)
            return;

        try
        {
            await hubConnection.StopAsync();
            await hubConnection.DisposeAsync();
        }
        catch (ObjectDisposedException)
        {
            // safe to ignore
        }
        catch (InvalidOperationException)
        {
            // hub already stopped / disposing
        }
    }

}