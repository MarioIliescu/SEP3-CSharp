@using ApiContracts.Dtos.Job
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Components.Authorization
@using ApiContracts.Enums
@inject IJobService JobService
@inject AuthenticationStateProvider AuthStateProvider
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Hubs
@using BlazorFleetApp.Services.Job
@inject FleetHubClient FleetHub
@if (job != null && !isLoading)
{
    <div>
        @if (userRole == UserRole.Driver)
        {
            if (status is JobStatus.Completed or JobStatus.Expired or JobStatus.Available)
            {
                <h4>No job being tracked, wait for your dispatcher</h4>
            }
            else
            {
                <div class="job-status-wrapper">
                    <img class="job-status-image" src="@GetStatusImage()" alt="Status"/>

                    <select class="job-status-select"
                            @bind="status">
                        @if (status == JobStatus.Assigned)
                        {
                            <option value="@JobStatus.Assigned">Select Option</option>
                            <option value="@JobStatus.Available">Deny Job</option>
                            <option value="@JobStatus.Accepted">Accept Job</option>
                        }
                        else
                        {
                            <option value="@JobStatus.Accepted">Job pending start</option>
                            <option value="@JobStatus.Loading">Loading the cargo</option>
                            <option value="@JobStatus.Ongoing">In route to destination</option>
                            <option value="@JobStatus.Unloading">Unloading cargo at destination</option>
                            <option value="@JobStatus.Completed">Job Completed</option>
                        }
                    </select>
                </div>
            }
        }

        @if (userRole == UserRole.Dispatcher)
        {
                <div class="job-status-wrapper">
                    <img class="job-status-image" src="@GetStatusImage()" alt="Status"/>

                    <div class="job-status-text-wrapper">
                        <span class="job-status-text">@status</span>
                    </div>
                </div>
        }
    </div>
}
else
{
    <div>Loading job...</div>
}



@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    [Parameter] public int? InitialJobId { get; set; }
    [Parameter] public JobDto? JobDto { get; set; }
    [Inject] private IJSRuntime JS { get; set; }
    private int userId;
    private UserRole? userRole;
    private JobDto? job;
    private JobStatus _status = JobStatus.Available;
    bool _notAcceptedYet = true;
    bool isLoading = true;

    private JobStatus status
    {
        get => _status;
        set
        {
            if (_status != value)
            {
                // Check for Completed
                if (value is JobStatus.Completed or JobStatus.Available)
                {
                    _ = ConfirmAndChangeStatusAsync(value); // async fire-and-forget
                }
                else if (_notAcceptedYet && value is JobStatus.Accepted)
                {
                    _notAcceptedYet = false;
                    _ = ConfirmAndChangeStatusAsync(value); // async fire-and-forget
                }
                else
                {
                    _status = value;
                    _ = ChangeStatusAsync(value);
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRoleAsync();
        await LoadJobAsync();
        if (job == null)
            return;

        await FleetHub.StartAsync();
        await FleetHub.JoinGroupAsync(job.Id.ToString());

        FleetHub.OnFleetEvent += HandleFleetEvent;

        isLoading = false;
    }

    private async Task LoadUserRoleAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var roleClaim = user.FindFirst("Role")?.Value;
            if (!string.IsNullOrEmpty(roleClaim) &&
                Enum.TryParse<UserRole>(roleClaim, true, out var parsedRole))
            {
                userRole = parsedRole;
            }
        }
    }

    private string GetStatusImage()
    {
        if (job == null)
        {
            return "/images/reddot.png";
        }

        return job.CurrentStatus switch
        {

            JobStatus.Available => "/images/JobStatus/unassigned_job_vector.png",
            JobStatus.Assigned => "/images/JobStatus/assigned_job_vector.png",
            JobStatus.Accepted => "/images/JobStatus/accepted_job_vector.png",
            JobStatus.Loading => "/images/JobStatus/loading_cargo_job_vector.png",
            JobStatus.Ongoing => "/images/JobStatus/ongoing_vector.png",
            JobStatus.Unloading => "/images/JobStatus/unloading_cargo_job_vector.png",
            JobStatus.Completed => "/images/JobStatus/completed_job_vector.png",
            JobStatus.Expired => "/images/JobStatus/expired_job_vector.png",
            _ => "/images/JobStatus/driverNo_job_vector.png"
        };
    }

    private async Task ChangeStatusAsync(JobStatus newStatus)
    {
        int driverId;
        if (job == null) return;
        if (newStatus is JobStatus.Available)
        {
            driverId = 0;
        }
        else
        {
            driverId = job.DriverId;
        }

        var dto = new UpdateJobDto
        {
            Title = job.Title,
            CargoInfo = job.CargoInfo,
            CurrentStatus = newStatus,
            DeliveryTime = job.DeliveryTime,
            Description = job.Description,
            DispatcherId = job.DispatcherId,
            DriverId = driverId,
            DropLocationState = job.DropLocationState,
            DropLocationZip = job.DropLocationZip,
            Id = job.Id,
            LoadedMiles = job.loadedMiles,
            WeightOfCargo = job.weightOfCargo,
            TypeOfTrailerNeeded = job.TypeOfTrailerNeeded,
            TotalPrice = job.TotalPrice,
            PickupTime = job.PickupTime,
            PickupLocationZip = job.PickupLocationZip,
            PickupLocationState = job.PickupLocationState,
        };
        await JobService.UpdateAsync(dto);

        await FleetHub.NotifyGroupAsync(
            job.Id.ToString(),
            FleetEventType.JobStatusChanged);

        _status = newStatus;
        await InvokeAsync(StateHasChanged);
        StateHasChanged();
    }

    private async Task RefreshJobAsync()
    {
        if (job != null)
        {
            job = await JobService.GetSingleAsync(job.Id);

            if (job != null)
                _status = job.CurrentStatus;
        }

        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        FleetHub.OnFleetEvent -= HandleFleetEvent;

        if (job != null)
            await FleetHub.LeaveGroupAsync(job.Id.ToString());
    }
    private async Task LoadJobAsync()
    {
        if (JobDto != null)
        {
            job = JobDto;
            _status = job.CurrentStatus;
        }
        else if (InitialJobId.HasValue)
        {
            job = await JobService.GetSingleAsync(InitialJobId.Value);
            if (job != null) _status = job.CurrentStatus;
        }
        else
        {
            job = null;
        }
    }

    private async Task ConfirmAndChangeStatusAsync(JobStatus newStatus)
    {
        string? statusText = newStatus switch
        {
            JobStatus.Available => "Are you sure you want to deny this job?",
            JobStatus.Completed => "Are you sure you want to mark this job as completed?",
            JobStatus.Accepted => "Are you sure you want to accept this job?",
            _ => string.Empty
        };
        bool confirmed = await JS.InvokeAsync<bool>("confirm",
            $"{statusText} This cannot be undone.");

        if (confirmed)
        {
            _status = newStatus;
            await ChangeStatusAsync(newStatus);
        }
        else
        {
            // Do nothing, revert to previous
            await InvokeAsync(StateHasChanged);
        }
    }
    private async Task HandleFleetEvent(FleetEventType eventType)
    {
        if (eventType is FleetEventType.JobStatusChanged
            or FleetEventType.JobAssigned
            or FleetEventType.JobsUpdated)
        {
            await RefreshJobAsync();
        }
    }


}