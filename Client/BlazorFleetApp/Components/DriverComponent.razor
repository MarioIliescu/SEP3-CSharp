@using ApiContracts.Company
@using ApiContracts.Dtos.Dispatcher
@using ApiContracts.Dtos.Driver
@using ApiContracts.Dtos.Job
@using ApiContracts.Enums
@implements IAsyncDisposable
@using BlazorFleetApp.Services
@using BlazorFleetApp.Services.Dispatcher
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Job
@using BlazorFleetApp.Services.Hubs
@using Microsoft.AspNetCore.Components.Authorization
@inject FleetHubClient FleetHub
@inject IDispatcherService DispatcherService
@inject IDriverService DriverService
@inject ICompanyService CompanyService
@inject IJobService JobService

@if (isLoading)
{
    <p>Loading</p>
}
else
{
    <div id="@DriverCardId" class="driver-card box-container p-3">
        @if (showExtraColumn)
        {
            <div class="overlay" @onclick="HideExtraColumn"></div>
        }

        <div class="row g-4 driver-main" @onclick="ToggleExtraColumn">
            <div class="col-xl-4 col-md-6 col-sm-12">
                <div class="driver-stack">
                    <h4 class="driver-name">@_driver?.FirstName @_driver?.LastName</h4>
                    <div class="company-name">@_company?.CompanyName</div>

                    @if (_driver?.Id != 0)
                    {
                        <div class="driver-status">
                            <DriverStatusComponent InitialDriverId="@_driver?.Id" />
                        </div>
                    }
                </div>
            </div>

            <div class="col-xl-4 col-md-6 col-sm-12">
                <div class="job-stack">
                    @if (_job != null)
                    {
                        <h4 class="job-route">@_job.PickupLocationZip, @_job.PickupLocationState â†’ @_job.DropLocationZip, @_job.DropLocationState</h4>
                        <div class="job-status">
                            @if (_job?.CurrentStatus is not (JobStatus.Available or JobStatus.Expired or JobStatus.Completed))
                            {
                                <JobStatusComponent JobDto="_job"></JobStatusComponent>
                            }
                        </div>
                    }
                    else
                    {
                        <h4 class="no-job text-muted">NO JOB ASSIGNED</h4>
                    }
                </div>
            </div>

            <div class="col-xl-4 col-md-6 col-sm-12">
                <div class="component-stack">
                    @Component
                </div>
            </div>
        </div>

        @if (showExtraColumn)
        {
            <div class="row g-4 mt-2 driver-extra">
                <h5 class="mb-2">Driver Info</h5>
                <p class="mb-1">Name: @_driver?.FirstName @_driver?.LastName</p>
                <p class="mb-1">MC Number: @_driver?.McNumber</p>
                <p class="mb-1">Company: @_company?.CompanyName</p>

                @if (_job != null)
                {
                    <h5 class="mb-2 mt-3">Assigned Job Info</h5>
                    <p class="mb-1">Job Title: @_job?.Title</p>
                    <p class="mb-0">Status: @_job?.CurrentStatus</p>
                    <p class="mb-0">Pick Up: @_job?.PickupLocationState, @_job?.PickupLocationZip</p>
                    <p class="mb-0">Delivery: @_job?.DropLocationState, @_job?.DropLocationZip</p>
                }
            </div>
        }
    </div>
}

@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public DriverDto? InitialDriver { get; set; }
    [Parameter] public JobDto? InitialJob { get; set; }
    [Parameter] public int? InitialJobId { get; set; }
    [Parameter] public DispatcherDto? InitialDispatcher { get; set; }
    [Parameter] public int? InitialDispatcherId { get; set; }
    [Parameter] public RenderFragment? Component { get; set; }
    [Parameter] public EventCallback<DriverDto> OnSelected { get; set; }

    private bool showExtraColumn;
    private bool isLoading = true;
    private DispatcherDto? _dispatcher;
    private DriverDto? _driver;
    private CompanyDto? _company;
    private JobDto? _job;
    private bool _disposed;

    private string DriverCardId => $"driverCard_{_driver?.Id.ToString() ?? Guid.NewGuid().ToString()}";

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            await LoadDispatcherAsync();
            await LoadDriverAsync();
            await LoadCompanyAsync();
            await LoadJobAsync();

            await FleetHub.StartAsync();
            FleetHub.OnFleetEvent -= HandleFleetEvent;
            FleetHub.OnFleetEvent += HandleFleetEvent;

            if (_dispatcher?.Id != null)
                await FleetHub.JoinGroupAsync(_dispatcher.Id.ToString());
            if (_driver?.Id != null)
                await FleetHub.JoinGroupAsync(_driver.Id.ToString());
        }
        finally
        {
            if (!_disposed)
                isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadDriverAsync()
    {
        if (InitialDriver != null)
            _driver = InitialDriver;
        else if (InitialDriverId.HasValue)
            _driver = await DriverService.GetSingleAsync(InitialDriverId.Value);
    }

    private async Task LoadCompanyAsync()
    {
        if (_driver?.McNumber != null)
            _company = await CompanyService.GetSingleAsync(_driver.McNumber);
    }

    private async Task LoadDispatcherAsync()
    {
        if (InitialDispatcher != null)
            _dispatcher = InitialDispatcher;
        else if (InitialDispatcherId.HasValue)
            _dispatcher = await DispatcherService.GetSingleAsync(InitialDispatcherId.Value);
    }

    private async Task LoadJobAsync()
    {
        if (_driver == null) return;

        if (InitialJob != null)
            _job = InitialJob;
        else if (InitialJobId.HasValue)
            _job = await JobService.GetSingleAsync(InitialJobId.Value);

        if (_job?.CurrentStatus is JobStatus.Available or JobStatus.Expired or JobStatus.Completed)
            _job = null;
    }

    private async Task RefreshDriverJobAsync()
    {
        if (_disposed || _driver == null) return;

        var allJobs = await JobService.GetAllAsync();
        _job = allJobs.FirstOrDefault(j =>
            j.DriverId == _driver.Id &&
            j.CurrentStatus is not (JobStatus.Available or JobStatus.Expired or JobStatus.Completed));

        if (_job?.CurrentStatus is JobStatus.Available or JobStatus.Expired or JobStatus.Completed)
            _job = null;

        if (!_disposed)
            await InvokeAsync(StateHasChanged);
    }


    private async Task LoadDriverStatusRefresh()
    {
        if (_disposed || _driver == null) return;

        var latest = await DriverService.GetSingleAsync(_driver.Id);
        if (latest != null)
            _driver = latest;

        if (!_disposed)
            await InvokeAsync(StateHasChanged);
    }

    private async Task HandleFleetEvent(FleetEventType evt)
    {
        if (_disposed) return;

        if (evt is FleetEventType.DriverStatusChanged or FleetEventType.DriversUpdated)
            await LoadDriverStatusRefresh();

        if (evt is FleetEventType.JobAssigned or FleetEventType.JobsUpdated or FleetEventType.JobStatusChanged)
            await RefreshDriverJobAsync();
    }

    private async Task ToggleExtraColumn()
    {
        if (_disposed) return;

        showExtraColumn = !showExtraColumn;
        if (OnSelected.HasDelegate && _driver != null)
            await OnSelected.InvokeAsync(_driver);
    }

    private void HideExtraColumn() => showExtraColumn = false;

    public async ValueTask DisposeAsync()
    {
        _disposed = true;

        FleetHub.OnFleetEvent -= HandleFleetEvent;

        if (_dispatcher?.Id != null)
            await FleetHub.LeaveGroupAsync(_dispatcher.Id.ToString());

        if (_driver?.Id != null)
            await FleetHub.LeaveGroupAsync(_driver.Id.ToString());
    }
}
