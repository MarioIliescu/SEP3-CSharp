@using ApiContracts.Company
@using ApiContracts.Dtos.Dispatcher
@implements IAsyncDisposable
@using ApiContracts.Dtos.Driver
@using ApiContracts.Dtos.Job
@using ApiContracts.Enums
@using BlazorFleetApp.Services
@using BlazorFleetApp.Services.Dispatcher
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Job
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavMgr
@inject IDispatcherService DispatcherService
@inject IDriverService DriverService
@inject ICompanyService CompanyService
@inject IJobService JobService
@if (isLoading)
{
    <p>Loading</p>
}
else
{
    <div id="@DriverCardId" class="driver-card box-container p-3">
        @if (showExtraColumn)
        {
            <div class="overlay" @onclick="HideExtraColumn"></div>
        }

        <div class="row g-4 driver-main" @onclick="ToggleExtraColumn">
            <div class="col-xl-4 col-md-6 col-sm-12">
                <div class="driver-stack">
                    <h4 class="driver-name">@_driver?.FirstName @_driver?.LastName</h4>
                    <div class="company-name">@_company?.CompanyName</div>

                    @if (_driver?.Id != 0)
                    {
                        <div class="driver-status">
                            <DriverStatusComponent InitialDriverId="@_driver?.Id"></DriverStatusComponent>
                        </div>
                    }
                </div>
            </div>

            <div class="col-xl-4 col-md-6 col-sm-12">
                <div class="job-stack">
                    @if (_job != null)
                    {
                        <h4 class="job-route">@_job.PickupLocationZip, @_job.PickupLocationState â†’ @_job.DropLocationZip, @_job.DropLocationState</h4>
                        <div class="job-status">
                            @if (_job?.DriverId == 0)
                            {
                                _job = null;
                            }
                            <JobStatusComponent JobDto="_job"></JobStatusComponent>
                        </div>
                    }
                    else
                    {
                        <h4 class="no-job text-muted">NO JOB ASSIGNED</h4>
                    }
                </div>
            </div>

            <div class="col-xl-4 col-md-6 col-sm-12">
                <div class="component-stack">
                    @if (Component != null)
                    {
                        <div>@Component</div>
                    }
                </div>
            </div>
        </div>

        @if (showExtraColumn)
        {
            <div class="row g-4 mt-2 driver-extra" @onclick:stopPropagation="true" @onclick="HandleExtraColumnClick">
                <h5 class="mb-2">Driver Info</h5>
                <p class="mb-1">Name: @_driver?.FirstName @_driver?.LastName</p>
                <p class="mb-1">MC Number: @_driver?.McNumber</p>
                <p class="mb-1">Company: @_company?.CompanyName</p>

                @if (_job != null)
                {
                    <h5 class="mb-2 mt-3">Assigned Job Info</h5>
                    <p class="mb-1">Job Title: @_job?.Title</p>
                    <p class="mb-0">Status: @_job?.CurrentStatus</p>
                    <p class="mb-0">Pick Up: @_job?.PickupLocationState, @_job?.PickupLocationZip</p>
                    <p class="mb-0">Delivery: @_job?.DropLocationState, @_job?.DropLocationZip</p>
                }
            </div>
        }
    </div>
}

@code {
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public DriverDto? InitialDriver { get; set; }
    [Parameter] public JobDto? InitialJob { get; set; }
    [Parameter] public int? InitialJobId { get; set; }
    [Parameter] public DispatcherDto? InitialDispatcher { get; set; }
    [Parameter] public int? InitialDispatcherId { get; set; }
    [Parameter] public RenderFragment? Component { get; set; }
    [Parameter] public EventCallback<DriverDto> OnSelected { get; set; }
    [Inject] private IJSRuntime JS { get; set; }
    private string DriverCardId => $"driverCard_{(ValueType)_driver?.Id ?? Guid.NewGuid()}";
    private bool showExtraColumn = false;
    private bool isLoading = true;
    private HubConnection? hubConnection;
    private DispatcherDto? _dispatcher;
    private DriverDto? _driver;
    private CompanyDto? _company;
    private JobDto? _job;
    private DotNetObjectReference<DriverComponent>? dotNetRef;
    private IJSObjectReference? module;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadDispatcherAsync();
            await LoadDriverAsync();
            await LoadCompanyAsync(_driver);
            await LoadJobFirstRenderAsync();

            if (_dispatcher != null || _driver != null)
                await SetupHubAsync();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SetupHubAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavMgr.ToAbsoluteUri("/fleethub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<FleetEventType>("FleetEvent", async (eventType) =>
        {
            if (eventType is FleetEventType.DriversUpdated or FleetEventType.DriverStatusChanged or
                FleetEventType.JobsUpdated or FleetEventType.JobAssigned
                or FleetEventType.JobStatusChanged)
            {
                await RefreshDriverJobAsync();
            }
        });

        await hubConnection.StartAsync();

        if (_dispatcher?.Id != null)
            await hubConnection.InvokeAsync("JoinGroup", _dispatcher.Id.ToString());

        if (_driver?.Id != null)
            await hubConnection.InvokeAsync("JoinGroup", _driver.Id.ToString());
    }


    private async Task LoadDriverAsync()
    {
        if (InitialDriver != null) _driver = InitialDriver;
        else if (InitialDriverId.HasValue) _driver = await DriverService.GetSingleAsync((int)InitialDriverId);
    }

    private async Task LoadCompanyAsync(DriverDto? driver)
    {
        if (driver?.McNumber != null)
            _company = await CompanyService.GetSingleAsync(driver.McNumber);
        else
            _company = null;
    }

    private async Task LoadJobFirstRenderAsync()
    {
        if (InitialJob != null)
            _job = InitialJob;
        else if (InitialJobId.HasValue)
            _job = await JobService.GetSingleAsync(InitialJobId.Value);
        else
            _job = null;
    }


    private async Task RefreshDriverJobAsync()
    {
        isLoading = true;
        try
        {
            if (_driver == null) return;
            await LoadDriverAsync();
            var allJobs = await JobService.GetAllAsync();
            _job = allJobs.FirstOrDefault(j =>
                j.DriverId == _driver.Id &&
                j.CurrentStatus is not (JobStatus.Available or JobStatus.Expired or JobStatus.Completed));

        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
        await InvokeAsync(StateHasChanged);
    }


    private async Task LoadDispatcherAsync()
    {
        if (InitialDispatcher != null)
            _dispatcher = InitialDispatcher;
        else if (InitialDispatcherId.HasValue)
            _dispatcher = await DispatcherService.GetSingleAsync(InitialDispatcherId.Value);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (InitialJob != _job)
        {
            _job = InitialJob;
            await InvokeAsync(StateHasChanged);
        }
    }
    private async Task ToggleExtraColumn()
    {
        showExtraColumn = !showExtraColumn;

        if (OnSelected.HasDelegate)
            await OnSelected.InvokeAsync(_driver);
    }

    [JSInvokable]
    public void HideExtraColumn()
    {
        showExtraColumn = false;
        StateHasChanged();
    }

    private async Task HandleExtraColumnClick()
    {
        if (OnSelected.HasDelegate)
            await OnSelected.InvokeAsync(_driver);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetRef?.Dispose();
            dotNetRef = DotNetObjectReference.Create(this);
            module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./Components/DriverComponent.razor.js"
            );
            await module.InvokeVoidAsync("registerClickOutside", dotNetRef, DriverCardId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        dotNetRef?.Dispose();
        if (hubConnection != null)
        {
            if (_dispatcher?.Id != null)
                await hubConnection.InvokeAsync("LeaveGroup", _dispatcher.Id.ToString());
            if (_driver?.Id != null)
                await hubConnection.InvokeAsync("LeaveGroup", _driver.Id.ToString());

            await hubConnection.StopAsync();
            await hubConnection.DisposeAsync();
        }
    }

}