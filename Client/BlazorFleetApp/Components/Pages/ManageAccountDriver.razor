@page "/manage-account-driver"
@using System.Text.RegularExpressions
@using ApiContracts.Dtos.Driver
@using ApiContracts.Enums
@using BlazorFleetApp.Services.Auth
@using BlazorFleetApp.Services.Driver
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IDriverService DriverService
@inject IAuthService AuthService
@attribute [Authorize]

<h3>Manage Account - Driver</h3>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <div class="alert alert-success" role="alert">
        @statusMessage
    </div>
}

<div class="mb-3">
    <label class="form-label">Email</label>
    <InputText class="form-control" @bind-Value="email"/>
</div>

<div class="mb-3">
    <label class="form-label">Phone Number</label>
    <InputText class="form-control" @bind-Value="phoneNumber"/>
</div>

<div class="mb-3">
    <label class="form-label">First Name</label>
    <InputText class="form-control" @bind-Value="firstName"/>
</div>

<div class="mb-3">
    <label class="form-label">Last Name</label>
    <InputText class="form-control" @bind-Value="lastName"/>
</div>

<div class="mb-3">
    <label class="form-label">Trailer Type</label>

    <InputSelect @bind-Value="trailerType" TValue="TrailerType">
        @foreach (var t in Enum.GetValues<TrailerType>())
        {
            <option value="@t">@t.ToString()</option>
        }
    </InputSelect>
</div>

<button class="btn btn-primary mt-3" @onclick="Save">
    Save Changes
</button>

@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }

    private DriverDto? driver;
    private string email = "";
    private string phoneNumber = "";
    private string firstName = "";
    private string lastName = "";
    private TrailerType trailerType;
    private string companyMC = "";
    private DriverCompanyRole companyRole;
    private DriverStatus status;
    private string statusMessage = "";
    private int userId = 0;
    private int locationZIP = 35010;
    private string locationState = "AL";

    private async Task Save()
    {
        try
        {
            if (driver == null)
                return; 

            statusMessage = "";
            List<string> errors = new();


            if (string.IsNullOrWhiteSpace(firstName))
                errors.Add("First name cannot be null or empty.");
            else if (firstName.Length < 3)
                errors.Add("First name must be at least 3 characters long.");
            else if (!Regex.IsMatch(firstName, "^[A-Za-z'-]+$"))
                errors.Add("First name contains invalid characters.");

            if (string.IsNullOrWhiteSpace(lastName))
                errors.Add("Last name cannot be null or empty.");
            else if (lastName.Length < 3)
                errors.Add("Last name must be at least 3 characters long.");
            else if (!Regex.IsMatch(lastName, "^[A-Za-z'-]+$"))
                errors.Add("Last name contains invalid characters.");

            if (string.IsNullOrWhiteSpace(email))
                errors.Add("Email cannot be null or empty.");
            else if (!Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
                errors.Add("Email format is invalid.");

            if (string.IsNullOrWhiteSpace(phoneNumber))
                errors.Add("Phone number cannot be null or empty.");
            else if (!Regex.IsMatch(phoneNumber, @"^\+?\d{1,3}([ -]?\d{2,4}){2,5}$"))
                errors.Add("Phone number format is invalid. Expected formats like +49 123 456 789 or +421-987-654-321.");
            
            if (errors.Any())
            {
                statusMessage = string.Join("\n", errors);
                return;
            }

            var updated = driver with
            {
                Email = email,
                PhoneNumber = phoneNumber,
                FirstName = firstName,
                LastName = lastName,
                TrailerType = trailerType,
                CompanyRole = companyRole,
                Status = status,
                Id = userId,
                LocationZip = locationZIP,
                LocationState = locationState
            };

            await DriverService.UpdateAsync(updated);
            await AuthService.RefreshTokenAsync();
            await LoadDriverDataAsync();
            statusMessage = "Driver information updated successfully!";
            StateHasChanged();
        }
        catch (Exception e)
        {
            statusMessage = e.Message;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDriverDataAsync();
    }

    private async Task LoadDriverDataAsync()
    {
        if (State == null)
            return;
        var authState = await State;
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated ?? false)
        {
            // Get user ID from claims
            userId = user.FindFirst("Id")?.Value is string idStr && int.TryParse(idStr, out var id) ? id : 0;

            if (userId > 0)
            {
                // Fetch the latest driver data from the backend
                driver = await DriverService.GetSingleAsync(userId);

                if (driver != null)
                {
                    // Map backend data to local fields
                    email = driver.Email;
                    firstName = driver.FirstName;
                    lastName = driver.LastName;
                    phoneNumber = driver.PhoneNumber;
                    trailerType = driver.TrailerType;
                    companyRole = driver.CompanyRole;
                    status = driver.Status;
                    companyMC = driver.McNumber;
                    locationState = driver.LocationState ?? "AL";
                    locationZIP = driver.LocationZip;
                }
            }
        }
    }

}