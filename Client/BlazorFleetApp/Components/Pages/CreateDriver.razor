@page "/create-driver"
@using System.Text.RegularExpressions
@using ApiContracts.Company
@using ApiContracts.Dtos.Driver
@using ApiContracts.Enums
@using BlazorFleetApp.Services
@using BlazorFleetApp.Services.Driver
@inject IDriverService DriverService
@inject ICompanyService CompanyService
@inject NavigationManager Nav
@rendermode InteractiveServer

<h3>Create Driver</h3>

@if (validationErrors.Any())
{
    <div class="alert alert-danger">
        @foreach (var err in validationErrors)
        {
            <div>@err</div>
        }
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info">@message</div>
}

<label>First name</label>
<input class="form-control mb-2" @bind="firstname" />

<label>Last name</label>
<input class="form-control mb-2" @bind="lastname" />

<label>Email address</label>
<input class="form-control mb-2" @bind="email" />

<label>Phone number</label>
<input class="form-control mb-2" @bind="phonenumber" />

<label>Password</label>
<input class="form-control mb-2" type="password" @bind="password" />

<label>Repeat password</label>
<input class="form-control mb-2" type="password" @bind="repeatPassword" />

<label>Company</label>
<select class="form-control mb-2" @bind="selectedCompanyMcNumber">
    <option value="">-- Select Company --</option>
    @foreach (var c in companies)
    {
        <option value="@c.McNumber">@c.McNumber - @c.CompanyName</option>
    }
</select>

<button class="btn btn-secondary mb-2" @onclick="GoToCreateCompany">
    Company not listed? Create new company
</button><br/>

<label>Trailer Type</label>
<select class="form-control mb-2" @bind="trailertype">
    <option value="">-- Select Trailer Type --</option>
    @foreach (var type in Enum.GetValues<TrailerType>())
    {
        <option value="@type">@type</option>
    }
</select>

<label>Location state (e.g. TX)</label>
<input class="form-control mb-2"  @bind="locationstate" />

<label>Location ZIP code</label>
<input class="form-control mb-2"  @bind="locationzipcode" />

<button class="btn btn-primary" @onclick="RegisterUser">Register</button>

@code {
    private string firstname = "";
    private string lastname = "";
    private string email = "";
    private string phonenumber = "";
    private string password = "";
    private string repeatPassword = "";   // <— added

    private string selectedCompanyMcNumber = "";
    private List<CreateCompanyDto> companies = new();

    private TrailerType? trailertype;
    private DriverStatus status = DriverStatus.available;
    private DriverCompanyRole role = DriverCompanyRole.Driver;

    private string locationstate = "AL";
    private int locationzipcode = 35010;

    private string message = "";
    private List<string> validationErrors = new();

    protected override async Task OnInitializedAsync()
    {
        companies = await CompanyService.GetAllAsync();
    }

    private void GoToCreateCompany()
    {
        Nav.NavigateTo("/company");
    }

    private async Task RegisterUser()
    {
        validationErrors.Clear();

        // --------------------------
        // VALIDATIONS FROM BACKEND
        // --------------------------

        // FIRST NAME
        if (string.IsNullOrWhiteSpace(firstname))
            validationErrors.Add("First name is required.");
        else if (firstname.Length < 3)
            validationErrors.Add("First name must be at least 3 characters long.");
        else if (!Regex.IsMatch(firstname, "^[A-Za-z'-]+$"))
            validationErrors.Add("First name contains invalid characters (allowed: letters, ' and -).");

        // LAST NAME
        if (string.IsNullOrWhiteSpace(lastname))
            validationErrors.Add("Last name is required.");
        else if (lastname.Length < 3)
            validationErrors.Add("Last name must be at least 3 characters long.");
        else if (!Regex.IsMatch(lastname, "^[A-Za-z'-]+$"))
            validationErrors.Add("Last name contains invalid characters (allowed: letters, ' and -).");

        // EMAIL (same regex as backend)
        if (string.IsNullOrWhiteSpace(email) ||
            !Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            validationErrors.Add("A valid email address is required.");

        // PHONE NUMBER (same as backend)
        if (string.IsNullOrWhiteSpace(phonenumber))
            validationErrors.Add("Phone number is required.");
        else if (!Regex.IsMatch(phonenumber, @"^\+?\d{1,3}([ -]?\d{2,4}){2,5}$"))
            validationErrors.Add("Phone number format is invalid (example: +49 123 456 789).");

        // PASSWORD (identical rules as backend)
        if (string.IsNullOrWhiteSpace(password))
            validationErrors.Add("Password is required.");
        else
        {
            if (password.Length < 8)
                validationErrors.Add("Password must be at least 8 characters long.");
            if (password.Length > 50)
                validationErrors.Add("Password cannot exceed 50 characters.");
            if (!Regex.IsMatch(password, @"[A-Z]"))
                validationErrors.Add("Password must contain at least one uppercase letter.");
            if (!Regex.IsMatch(password, @"[a-z]"))
                validationErrors.Add("Password must contain at least one lowercase letter.");
            if (!Regex.IsMatch(password, @"[0-9]"))
                validationErrors.Add("Password must contain at least one digit.");
        }
        // REPEAT PASSWORD MATCH
        if (password != repeatPassword)
            validationErrors.Add("Passwords do not match.");


        // COMPANY
        if (string.IsNullOrWhiteSpace(selectedCompanyMcNumber))
            validationErrors.Add("You must select a company.");

        // TRAILER TYPE
        if (trailertype is null)
            validationErrors.Add("You must select a trailer type.");

        // STATE (backend requires 2 letters)
        if (string.IsNullOrWhiteSpace(locationstate))
            validationErrors.Add("Location state is required.");
        else if (!Regex.IsMatch(locationstate, "^[A-Za-z]{2}$"))
            validationErrors.Add("State must be exactly 2 letters (A–Z).");

        // ZIP CODE
        if (locationzipcode <= 0 || locationzipcode >= 100000)
            validationErrors.Add("ZIP code must be between 1 and 99999.");

        // If any validation failed — stop here
        if (validationErrors.Any())
            return;


        try
        {
            await DriverService.CreateAsync(
                new CreateDriverDto(
                    firstname,
                    lastname,
                    email,
                    phonenumber,
                    password,
                    selectedCompanyMcNumber,
                    trailertype.Value,
                    status,
                    role,
                    locationstate,
                    locationzipcode
                )
            );

            message = "Driver created successfully!";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }
}
