@page "/create-dispatcher"
@using System.Numerics
@using System.Text.RegularExpressions
@using ApiContracts.Company
@using ApiContracts.Dtos.Dispatcher
@using ApiContracts.Enums
@using BlazorFleetApp.Services
@using BlazorFleetApp.Services.Dispatcher
@inject IDispatcherService DispatcherService
@inject ICompanyService CompanyService
@inject NavigationManager Nav
@rendermode InteractiveServer

<h3>Create Dispatcher</h3>

@if (validationErrors.Any())
{
    <div class="alert alert-danger">
        @foreach (var err in validationErrors)
        {
            <div>@err</div>
        }
    </div>
}

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info">@message</div>
}

<input class="form-control mb-2" placeholder="First name" @bind="firstname" />
<input class="form-control mb-2" placeholder="Last name" @bind="lastname" />
<input class="form-control mb-2" placeholder="Email address" @bind="email" />
<input class="form-control mb-2" placeholder="Phone number" @bind="phonenumber" />
<input class="form-control mb-2" placeholder="Password" type="password" @bind="password" />
<input class="form-control mb-2" placeholder="Repeat password" type="password" @bind="repeatPassword" />
<input class="form-control mb-2" placeholder="Current Rate" @bind="currentRate" />

<button class="btn btn-primary" @onclick="RegisterUser">Register</button>

@code {
    private string firstname = "";
    private string lastname = "";
    private string email = "";
    private string phonenumber = "";
    private string password = "";
    private string repeatPassword = "";   // <â€” added

    private double currentRate;

    private string message = "";
    private List<string> validationErrors = new();

    private async Task RegisterUser()
    {
        validationErrors.Clear();
        
        //Validation

        // FIRST NAME
        if (string.IsNullOrWhiteSpace(firstname))
            validationErrors.Add("First name is required.");
        else if (firstname.Length < 3)
            validationErrors.Add("First name must be at least 3 characters long.");
        else if (!Regex.IsMatch(firstname, "^[A-Za-z'-]+$"))
            validationErrors.Add("First name contains invalid characters (allowed: letters, ' and -).");

        // LAST NAME
        if (string.IsNullOrWhiteSpace(lastname))
            validationErrors.Add("Last name is required.");
        else if (lastname.Length < 3)
            validationErrors.Add("Last name must be at least 3 characters long.");
        else if (!Regex.IsMatch(lastname, "^[A-Za-z'-]+$"))
            validationErrors.Add("Last name contains invalid characters (allowed: letters, ' and -).");

        // EMAIL (same regex as backend)
        if (string.IsNullOrWhiteSpace(email) ||
            !Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            validationErrors.Add("A valid email address is required.");

        // PHONE NUMBER (same as backend)
        if (string.IsNullOrWhiteSpace(phonenumber))
            validationErrors.Add("Phone number is required.");
        else if (!Regex.IsMatch(phonenumber, @"^\+?\d{1,3}([ -]?\d{2,4}){2,5}$"))
            validationErrors.Add("Phone number format is invalid (example: +49 123 456 789).");

        // PASSWORD (identical rules as backend)
        if (string.IsNullOrWhiteSpace(password))
            validationErrors.Add("Password is required.");
        else
        {
            if (password.Length < 8)
                validationErrors.Add("Password must be at least 8 characters long.");
            if (password.Length > 50)
                validationErrors.Add("Password cannot exceed 50 characters.");
            if (!Regex.IsMatch(password, @"[A-Z]"))
                validationErrors.Add("Password must contain at least one uppercase letter.");
            if (!Regex.IsMatch(password, @"[a-z]"))
                validationErrors.Add("Password must contain at least one lowercase letter.");
            if (!Regex.IsMatch(password, @"[0-9]"))
                validationErrors.Add("Password must contain at least one digit.");
        }
        // REPEAT PASSWORD MATCH
        if (password != repeatPassword)
            validationErrors.Add("Passwords do not match.");


        // CURRENT RATE
        if (currentRate < 1)
            validationErrors.Add("Current Rate must be a positive number");

        // If any validation failed
        if (validationErrors.Any())
            return;


        try
        {
            await DispatcherService.CreateAsync(
                new CreateDispatcherDto(
                    firstname,
                    lastname,
                    email,
                    phonenumber,
                    currentRate,
                    password
                )
            );

            message = "Dispatcher created successfully!";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }
}
