@page "/assign-job"
@using ApiContracts.Dtos.Job
@using ApiContracts.Dtos.Driver
@using ApiContracts.Enums
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Job
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject IJobService JobServiceClient
@inject IDriverService DriverServiceClient
@inject AuthenticationStateProvider AuthProvider

@attribute [Authorize]
<h2>Assign Job</h2>

<AuthorizeView>
    <Authorized>

        @if (!string.IsNullOrWhiteSpace(message))
        {
            <div class="alert alert-success">@message</div>
        }

        @if (validationErrors.Any())
        {
            <div class="alert alert-danger">
                @foreach (var e in validationErrors)
                {
                    <p>@e</p>
                }
            </div>
        }

        @if (jobs == null)
        {
            <p>Loading...</p>
        }
        else
        {
            <div class="job-card-list">
                @foreach (var job in jobs)
                {
                    <div class="job-card @(job.Id == assigningJobId ? "selected" : "")">
                        <h4 @onclick="() => SelectJob(job.Id)">@job.Title</h4>
                        <p @onclick="() => SelectJob(job.Id)">
                            @job.PickupLocationState @job.PickupLocationZip → @job.DropLocationState @job.DropLocationZip
                        </p>
                        <p @onclick="() => SelectJob(job.Id)">
                            @job.PickupTime.ToString("MM/dd/yyyy HH:mm")
                        </p>

                        @if (job.Id == assigningJobId)
                        {
                            <div class="expanded-details">
                                <p><strong>Description:</strong> @job.Description</p>
                                <p><strong>Cargo:</strong> @job.CargoInfo</p>
                                <p><strong>Trailer:</strong> @job.TypeOfTrailerNeeded</p>
                                <p><strong>Status:</strong> @job.CurrentStatus</p>

                                <hr />

                                <label>Select Driver:</label>
                                <select @bind="selectedDriverId" @onclick:stopPropagation="true">
                                    <option value="0">Select Driver</option>
                                    @foreach (var d in drivers)
                                    {
                                        <option value="@d.Id">@d.FirstName @d.LastName</option>
                                    }
                                </select>

                                <button class="btn btn-primary" @onclick="ConfirmAssignDriver">
                                    Assign Driver
                                </button>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </Authorized>

    <NotAuthorized>
        <h3>Access denied — dispatchers only.</h3>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<JobDto>? jobs;
    private List<DriverDto>? drivers;

    private int assigningJobId = 0;
    private int selectedDriverId = 0;
    private int dispatcherId = 0;

    private string message = "";
    private List<string> validationErrors = new();

    [CascadingParameter] public Task<AuthenticationState>? State { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var auth = await State!;
        dispatcherId = int.Parse(auth.User.Claims.First(c => c.Type == "Id").Value);

        jobs = await JobServiceClient.GetAllAsync();
        drivers = await DriverServiceClient.GetAllAsync();
    }

    private void SelectJob(int jobId)
    {
        assigningJobId = jobId;
        selectedDriverId = 0;     
        message = "";
        validationErrors.Clear();
    }

    private async Task ConfirmAssignDriver()
    {
        validationErrors.Clear();
        message = "";

        if (assigningJobId <= 0)
            validationErrors.Add("No job selected.");

        if (selectedDriverId <= 0)
            validationErrors.Add("Please select a driver.");

        if (validationErrors.Any())
            return;

        try
        {
            await JobServiceClient.AssignDriverDispatcherAsync(
                assigningJobId,
                selectedDriverId,
                dispatcherId
            );

            // Refresh UI
            jobs = await JobServiceClient.GetAllAsync();
            assigningJobId = 0;
            selectedDriverId = 0;

            message = "Driver successfully assigned!";
        }
        catch (Exception ex)
        {
            validationErrors.Add($"Error: {ex.Message}");
        }
    }
}
