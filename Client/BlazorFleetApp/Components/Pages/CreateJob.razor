@page "/create-job"
@using System.Text.RegularExpressions
@using ApiContracts.Enums
@using ApiContracts.Dtos.Job
@using BlazorFleetApp.Services.Job
@using BlazorFleetApp.Services.Dispatcher
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@inject NavigationManager Nav
@inject IJobService JobService
@inject IDispatcherService DispatcherService
@inject AuthenticationStateProvider AuthProvider

@attribute [Authorize]

<link rel="stylesheet" href="css/createJob.css">

<div class="centered-content-container"> 

    <div class="logo-container">
        <img src="images/LogoDrive.png" alt="logo">
    </div>

    <h2 class="page-title">CREATE A NEW JOB</h2>

    <div class="form-card">

        <div class="message-panel @successClass">
            @foreach (var e in validationErrors.Take(5))
            {
                <p>@e</p>
            }
            @if (validationErrors.Count > 5)
            {
                <p>...</p>
            }
        </div>

        <label class="form-label">Job Title</label>
        <input class="form-input" type="text" placeholder="Title" @bind="title" />

        <label class="form-label">Description</label>
        <textarea class="form-textarea"
                  placeholder="Description (max 300 chars)"
                  maxlength="300"
                  @bind="description"></textarea>

        <div class="two-column">
            <div class="column">
                <label class="form-label">Loaded Miles</label>
                <input class="form-input" type="number" placeholder="Loaded Miles" @bind="loadedMiles" />
            </div>

            <div class="column">
                <label class="form-label">Cargo Weight </label>
                <input class="form-input" type="number" placeholder="Weight" @bind="weight" />
            </div>
        </div>

        <label class="form-label">Trailer Type</label>
        <select class="form-input" @bind="trailerType">
            @foreach (TrailerType t in Enum.GetValues(typeof(TrailerType)))
            {
                <option value="@t">@t</option>
            }
        </select>

        <label class="form-label">Base Price (without rate)</label>
        <input class="form-input"
               type="number"
               @bind-value="basePrice"
               @bind-value:event="oninput" />


        <label class="form-label">Total Price (with dispatcher rate)</label>
        <input class="form-input" type="number" @bind="totalPrice" readonly />

        <label class="form-label">Cargo Info</label>
        <input class="form-input" type="text" placeholder="Short cargo description" maxlength="30" @bind="cargoInfo" />

        <label class="form-label">Pickup Time</label>
        <input class="form-input" type="datetime-local" @bind="pickupTime" />

        <label class="form-label">Delivery Time</label>
        <input class="form-input" type="datetime-local" @bind="deliveryTime" />

        <label class="form-label">Pickup Location</label>
        <div class="two-column">
            <div class="column">
                <label class="form-label small">State</label>
                <input class="form-input" type="text" maxlength="2" placeholder="State" @bind="pickupState" />
            </div>
            <div class="column">
                <label class="form-label small">ZIP</label>
                <input class="form-input" type="number" placeholder="ZIP" @bind="pickupZip" />
            </div>
        </div>

        <label class="form-label">Drop Location</label>
        <div class="two-column">
            <div class="column">
                <label class="form-label small">State</label>
                <input class="form-input" type="text" maxlength="2" placeholder="State" @bind="dropState" />
            </div>
            <div class="column">
                <label class="form-label small">ZIP</label>
                <input class="form-input" type="number" placeholder="ZIP" @bind="dropZip" />
            </div>
        </div>

        <button class="primary-button" @onclick="CreateJobBlazor">Create Job</button>
    </div>

</div>

@code {
    private string successClass = "";
    private List<string> validationErrors = new();

    private string title = "";
    private string description = "";
    private int loadedMiles;
    private int weight;
    private TrailerType trailerType = TrailerType.Dry_van;

    private int _basePrice;
    private int basePrice
    {
        get => _basePrice;
        set
        {
            _basePrice = value;
            RecalculatePrice();
        }
    }      
    private int totalPrice;     

    private string cargoInfo = "";

    private DateTime pickupTime = DateTime.Now;
    private DateTime deliveryTime = DateTime.Now;

    private string pickupState = "";
    private int pickupZip;
    private string dropState = "";
    private int dropZip;

    private int dispatcherId = 0;
    private decimal dispatcherRatePercent; 

    [CascadingParameter] public Task<AuthenticationState> State { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var authState = await State;
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated ?? false)
        {
            dispatcherId = int.Parse(user.Claims.FirstOrDefault(c => c.Type == "Id")?.Value ?? "0");

            var dispatcher = await DispatcherService.GetSingleAsync(dispatcherId);
            if (dispatcher != null)
            {
                dispatcherRatePercent = (decimal)dispatcher.CurrentRate;
            }
        }
    }

    private void RecalculatePrice()
    {
        decimal rate = dispatcherRatePercent;  // e.g., 20%
        totalPrice = (int)(basePrice * (1 + rate));
    }

    private async Task CreateJobBlazor()
    {
        validationErrors.Clear();
        successClass = "";

        if (dispatcherId <= 0)
            validationErrors.Add("Dispatcher ID must be positive.");

        if (string.IsNullOrWhiteSpace(title))
            validationErrors.Add("Title is required.");
        else if (title.Length > 20)
            validationErrors.Add("Title cannot exceed 20 characters.");

        if (description.Length > 300)
            validationErrors.Add("Description cannot exceed 300 characters.");

        if (loadedMiles <= 0)
            validationErrors.Add("Loaded miles must be greater than 0.");

        if (weight <= 0)
            validationErrors.Add("Weight must be greater than 0.");

        if (basePrice <= 0)
            validationErrors.Add("Base price must be greater than 0.");

       // if (totalPrice <= 0)
          //  validationErrors.Add("Total price must be greater than 0.");

        if (string.IsNullOrWhiteSpace(cargoInfo))
            validationErrors.Add("Cargo info is required.");
        else if (cargoInfo.Length > 30)
            validationErrors.Add("Cargo info cannot exceed 20 characters.");

        if (pickupTime <= DateTime.Now)
            validationErrors.Add("Pickup time must be in the future.");

        if (deliveryTime <= pickupTime)
            validationErrors.Add("Delivery time must be after pickup time.");

        if (validationErrors.Any())
            return;

        var dto = new CreateJobDto(
            DispatcherId: dispatcherId,
            Title: title,
            Description: description,
            loadedMiles,
            weight,
            TypeOfTrailerNeeded: trailerType,
            TotalPrice: totalPrice,
            CargoInfo: cargoInfo,
            PickupTime: pickupTime,
            DeliveryTime: deliveryTime,
            PickupLocationState: pickupState.ToUpper(),
            PickupLocationZip: pickupZip,
            DropLocationState: dropState.ToUpper(),
            DropLocationZip: dropZip
        );

        try
        {
            await JobService.CreateAsync(dto);

            successClass = "success";
            validationErrors.Add("Job created successfully!");

            // Reset fields
            title = "";
            description = "";
            loadedMiles = 0;
            weight = 0;
            basePrice = 0;
            totalPrice = 0;
            cargoInfo = "";
            pickupState = "";
            dropState = "";
            pickupZip = 0;
            dropZip = 0;
            trailerType = TrailerType.Dry_van;

        }
        catch (Exception ex)
        {
            validationErrors.Add($"Error: {ex.Message}");
        }
    }
}
