@page "/register-driver"
@layout LoginRegisterLayout
@using BlazorFleetApp.Components.Layout
@using System.Text.RegularExpressions
@using ApiContracts.Company
@using ApiContracts.Dtos.Driver
@using ApiContracts.Enums
@using BlazorFleetApp.Services
@using BlazorFleetApp.Services.Driver
@using Microsoft.AspNetCore.Components.Authorization
@inject IDriverService DriverService
@inject ICompanyService CompanyService
@inject NavigationManager Nav
@rendermode InteractiveServer

<link rel="stylesheet" href="css/registerDriverStyle.css">
<AuthorizeView>
    <Authorized>
        Safe heaven for those who are logged in
    </Authorized>
    <NotAuthorized>
        <div class="logo-container">
            <img src="images/LogoDrive.png" alt="logo">
        </div>

        <h2 id="catch-phrase">STAY ALERT, STAY SAFE!</h2>
        
        <div class="name-fields">
            <input id="firstname-field" type="text" placeholder="First Name" @bind="firstname"/>
            <input id="lastname-field" type="text" placeholder="Last Name" @bind="lastname"/>
        </div>
        <input id="phone-number-field" type="text" placeholder="Phone number" @bind="phonenumber"/>
        <input id="email-field" type="text" placeholder="Email Address" @bind="email"/>
        <div class="password-with-rules">
            <div class="password-wrapper">
                <input id="password-field" type="@passwordFieldType" placeholder="Create Password" @bind="password"/>
                <img class="show-password-vector" src="images/ShowPasswordVector.png" @onclick="TogglePasswordField"/>
            </div>
            <div class="rules-trigger">
                <img class="show-password-rules-vector" src="images/PasswordRules.png"/>
                <div class="rules">
                    <p>Must be at least 8 characters long</p>
                    <p>Can't exceed 50 characters</p>
                    <p>Include upper & lower case letters</p>
                    <p>Include at least one number</p>
                </div>
            </div>
        </div>
        <div class="password-wrapper">
            <input id="confirm-password-field" type="@confirmPasswordFieldType" placeholder="Confirm password" @bind="repeatPassword"/>
            <img class="show-password-vector" src="images/ShowPasswordVector.png" @onclick="ToggleConfirmPasswordField"/>
        </div>
        <div class="company-section">
            <select class="company-select" @bind="selectedCompanyMcNumber">
                <option value="">Select Company</option>
                @foreach (var c in companies)
                {
                    <option value="@c.McNumber">@c.McNumber — @c.CompanyName</option>
                }
            </select>
            <button class="add-company-button" @onclick="TogglePopupCompany"><img src="images/AddCompanyButton.png" alt="Add Company"></button>
        </div>
        <div class="company-popup @popup">


            <div class="create-company-form">
                <input id="mc-number-field" type="text" placeholder="Mc Number"/>
                <input id="company-name-field" type="text" placeholder="Company name"/>
            </div>
            <button class="save-button">Save</button>
        </div>
        <select class="role-select" @bind="role" >
            <option value="@DriverCompanyRole.Driver">Driver</option>
            <option value="@DriverCompanyRole.OwnerOperator">Owner Operator</option>
        </select>
        <div class="error-message-popup">
            @if (validationErrors.Count > 5)
            {
                int temp = 0;
                foreach (var v in validationErrors)
                {
                    <p>@v</p>
                    temp++;
                    if (temp == 5)
                    {
                        <p>...</p>
                        break;
                    }
                }
            }
            else
            {
                @foreach (var v in validationErrors)
                {
                    <p>@v</p>
                }
            }
        </div>
        <button class="register-button" @onclick="RegisterUser">Create Account</button>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string firstname = "";
    private string lastname = "";
    private string email = "";
    private string phonenumber = "";
    private string password = "";
    private string repeatPassword = "";   // <— added
    private string passwordFieldType = "password";
    private string confirmPasswordFieldType = "password";
    private string popup = "";

    private string selectedCompanyMcNumber = "";
    private List<CreateCompanyDto> companies = new();

    private TrailerType trailertype = TrailerType.dry_van;
    private DriverStatus status = DriverStatus.available;
    private DriverCompanyRole role;

    private string locationstate = "AL";
    private int locationzipcode = 35010;

    private string message = "";
    private List<string> validationErrors = new();

    protected override async Task OnInitializedAsync()
    {
        companies = await CompanyService.GetAllAsync();
    }

    private void GoToCreateCompany()
    {
        Nav.NavigateTo("/company");
    }

    private async Task RegisterUser()
    {
        validationErrors.Clear();

        // --------------------------
        // VALIDATIONS FROM BACKEND
        // --------------------------

        // FIRST NAME
        if (string.IsNullOrWhiteSpace(firstname))
            validationErrors.Add("First name is required.");
        else if (firstname.Length < 3)
            validationErrors.Add("First name must be at least 3 characters long.");
        else if (!Regex.IsMatch(firstname, "^[A-Za-z'-]+$"))
            validationErrors.Add("First name contains invalid characters (allowed: letters, ' and -).");

        // LAST NAME
        if (string.IsNullOrWhiteSpace(lastname))
            validationErrors.Add("Last name is required.");
        else if (lastname.Length < 3)
            validationErrors.Add("Last name must be at least 3 characters long.");
        else if (!Regex.IsMatch(lastname, "^[A-Za-z'-]+$"))
            validationErrors.Add("Last name contains invalid characters (allowed: letters, ' and -).");

        // EMAIL (same regex as backend)
        if (string.IsNullOrWhiteSpace(email) ||
            !Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            validationErrors.Add("A valid email address is required.");

        // PHONE NUMBER (same as backend)
        if (string.IsNullOrWhiteSpace(phonenumber))
            validationErrors.Add("Phone number is required.");
        else if (!Regex.IsMatch(phonenumber, @"^\+?\d{1,3}([ -]?\d{2,4}){2,5}$"))
            validationErrors.Add("Phone number format is invalid (example: +49 123 456 789).");

        // PASSWORD (identical rules as backend)
        if (string.IsNullOrWhiteSpace(password))
            validationErrors.Add("Password is required.");
        else
        {
            if (password.Length < 8)
                validationErrors.Add("Password must be at least 8 characters long.");
            if (password.Length > 50)
                validationErrors.Add("Password cannot exceed 50 characters.");
            if (!Regex.IsMatch(password, @"[A-Z]"))
                validationErrors.Add("Password must contain at least one uppercase letter.");
            if (!Regex.IsMatch(password, @"[a-z]"))
                validationErrors.Add("Password must contain at least one lowercase letter.");
            if (!Regex.IsMatch(password, @"[0-9]"))
                validationErrors.Add("Password must contain at least one digit.");
        }
        // REPEAT PASSWORD MATCH
        if (password != repeatPassword)
            validationErrors.Add("Passwords do not match.");


        // COMPANY
        if (string.IsNullOrWhiteSpace(selectedCompanyMcNumber))
            validationErrors.Add("You must select a company.");
        

        // STATE (backend requires 2 letters)
        if (string.IsNullOrWhiteSpace(locationstate))
            validationErrors.Add("Location state is required.");
        else if (!Regex.IsMatch(locationstate, "^[A-Za-z]{2}$"))
            validationErrors.Add("State must be exactly 2 letters (A–Z).");

        // ZIP CODE
        if (locationzipcode <= 0 || locationzipcode >= 100000)
            validationErrors.Add("ZIP code must be between 1 and 99999.");

        // If any validation failed — stop here
        if (validationErrors.Any())
            return;


        try
        {
            await DriverService.CreateAsync(
                new CreateDriverDto(
                    firstname,
                    lastname,
                    email,
                    phonenumber,
                    password,
                    selectedCompanyMcNumber,
                    trailertype,
                    status,
                    role,
                    locationstate,
                    locationzipcode
                )
            );

            message = "Driver created successfully!";
        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }

    private void TogglePasswordField()
    {
        passwordFieldType = passwordFieldType == "password" ? "text" : "password";
    }

    private void ToggleConfirmPasswordField()
    {
        confirmPasswordFieldType = confirmPasswordFieldType == "password" ? "text" : "password";
    }

    private void TogglePopupCompany()
    {
        popup = popup == "" ? "active" : "";
    }
}
