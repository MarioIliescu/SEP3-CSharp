@page "/register-dispatcher"
@layout LoginRegisterLayout
@using BlazorFleetApp.Components.Layout
@using System.Text.RegularExpressions
@using ApiContracts.Dtos.Dispatcher
@using BlazorFleetApp.Services.Auth.Security
@using BlazorFleetApp.Services.Dispatcher
@using Microsoft.AspNetCore.Components.Authorization
@inject IDispatcherService DispatcherService
@inject NavigationManager NavMgr
@rendermode InteractiveServer

<link rel="stylesheet" href="css/registerDispatcherStyle.css"/>
<AuthorizeView>
    <Authorized>
        <h2>Safe heaven for those who are logged in</h2>
    </Authorized>
    <NotAuthorized>
        <div class="logo-container">
            <img src="images/LogoDispatcher.png" alt="logo">
        </div>

        <h2 id="catch-phrase">WHO'S READY TO DISPATCH!</h2>
        
        <div class="name-fields">
            <input id="firstname-field" type="text" placeholder="First Name" @bind="_firstname"/>
            <input id="lastname-field" type="text" placeholder="Last Name" @bind="_lastname"/>
        </div>
        
        <input id="phone-number-field" type="text" placeholder="Phone Number" @bind="_phonenumber"/>
        <input id="email-field" type="text" placeholder="Email" @bind="_email"/>
        <div class="password-with-rules">
            <div class="password-wrapper">
                <input id="password-field" type="@_passwordFieldType" placeholder="Create Password" @bind="_password"/>
                <img class="show-password-vector" src="images/ShowPasswordVector.png" @onclick="TogglePasswordField"/>
            </div>
            <div class="rules-trigger">
                <img class="show-password-rules-vector" src="images/PasswordRules.png"/>
                <div class="rules">
                    <p>Must be at least 8 characters long</p>
                    <p>Can't exceed 50 characters</p>
                    <p>Include upper & lower case letters</p>
                    <p>Include at least one number</p>
                </div>
            </div>
        </div>
        <div class="password-wrapper">
            <input id="confirm-password-field" type="@_confirmPasswordFieldType" placeholder="Confirm password" @bind="_repeatPassword"/>
            <img class="show-password-vector" src="images/ShowPasswordVector.png" @onclick="ToggleConfirmPasswordField"/>
        </div>
        
        <div class="error-message-popup @_successClass">
            @if (_validationErrors.Count > 5)
            {
                int temp = 0;
                foreach (var v in _validationErrors)
                {
                    <p>@v</p>
                    temp++;
                    if (temp == 5)
                    {
                        <p>...</p>
                        break;
                    }
                }
            }
            else
            {
                @foreach (var v in _validationErrors)
                {
                    <p>@v</p>
                }
            }
        </div>
        <button class="register-button" @onclick="RegisterUser">Create Account</button>
        <div class="d-flex justify-content-center mb-auto">
            <p class="login-redirect" >Already have an account? <a href="#" @onclick="GoToLogin">Login</a> </p>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string _firstname = "";
    private string _lastname = "";
    private string _email = "";
    private string _phonenumber = "";
    private string _password = "";
    private string _repeatPassword = "";
    private string _passwordFieldType = "password";
    private string _confirmPasswordFieldType = "password";
    private string _successClass = "";

    private double _currentRate = 1;

    private string _message = "";
    private List<string> _validationErrors = new();

    private async Task RegisterUser()
    {
        _validationErrors.Clear();
        
        //Validation

        // FIRST NAME
        if (string.IsNullOrWhiteSpace(_firstname))
            _validationErrors.Add("First name is required.");
        else if (_firstname.Length < 3)
            _validationErrors.Add("First name must be at least 3 characters long.");
        else if (!Regex.IsMatch(_firstname, "^[A-Za-z'-]+$"))
            _validationErrors.Add("First name contains invalid characters (allowed: letters, ' and -).");

        // LAST NAME
        if (string.IsNullOrWhiteSpace(_lastname))
            _validationErrors.Add("Last name is required.");
        else if (_lastname.Length < 3)
            _validationErrors.Add("Last name must be at least 3 characters long.");
        else if (!Regex.IsMatch(_lastname, "^[A-Za-z'-]+$"))
            _validationErrors.Add("Last name contains invalid characters (allowed: letters, ' and -).");

        // EMAIL (same regex as backend)
        if (string.IsNullOrWhiteSpace(_email) ||
            !Regex.IsMatch(_email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            _validationErrors.Add("A valid email address is required.");

        // PHONE NUMBER (same as backend)
        if (string.IsNullOrWhiteSpace(_phonenumber))
            _validationErrors.Add("Phone number is required.");
        else if (!Regex.IsMatch(_phonenumber, @"^\+?\d{1,3}([ -]?\d{2,4}){2,5}$"))
            _validationErrors.Add("Phone number format is invalid (example: +49 123 456 789).");

        // PASSWORD (identical rules as backend)
        if (string.IsNullOrWhiteSpace(_password))
            _validationErrors.Add("Password is required.");
        else
        {
            if (_password.Length < 8)
                _validationErrors.Add("Password must be at least 8 characters long.");
            if (_password.Length > 50)
                _validationErrors.Add("Password cannot exceed 50 characters.");
            if (!Regex.IsMatch(_password, @"[A-Z]"))
                _validationErrors.Add("Password must contain at least one uppercase letter.");
            if (!Regex.IsMatch(_password, @"[a-z]"))
                _validationErrors.Add("Password must contain at least one lowercase letter.");
            if (!Regex.IsMatch(_password, @"[0-9]"))
                _validationErrors.Add("Password must contain at least one digit.");
        }
        // REPEAT PASSWORD MATCH
        if (_password != _repeatPassword)
            _validationErrors.Add("Passwords do not match.");


        // CURRENT RATE
        if (_currentRate < 1)
            _validationErrors.Add("Current Rate must be a positive number");

        // If any validation failed
        if (_validationErrors.Any())
            return;


        try
        {
            await DispatcherService.CreateAsync(
                new CreateDispatcherDto(
                    0,
                    _firstname,
                    _lastname,
                    _email,
                    _phonenumber,
                    _currentRate/ 100,
                    PasswordHasherFront.Hash(_password)
                )
            );

            _message = "Dispatcher created successfully!";
            ToggleSuccessClass();
            _validationErrors.Add("Dispatcher created successfully");
            await InvokeAsync(StateHasChanged);
            await Task.Delay(3000);
            NavMgr.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            _message = $"Error: {ex.Message}";
        }
    }
    
    private void TogglePasswordField()
    {
        _passwordFieldType = _passwordFieldType == "password" ? "text" : "password";
    }

    private void ToggleConfirmPasswordField()
    {
        _confirmPasswordFieldType = _confirmPasswordFieldType == "password" ? "text" : "password";
    }

    private void ToggleSuccessClass()
    {
        _successClass = _successClass == "" ? "success" : "";
    }

    private void GoToLogin()
    {
        NavMgr.NavigateTo("/login");
    }
}
