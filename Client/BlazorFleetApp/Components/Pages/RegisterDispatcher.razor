@page "/register-dispatcher"
@using System.Text.RegularExpressions
@using ApiContracts.Dtos.Dispatcher
@using BlazorFleetApp.Services.Dispatcher
@inject IDispatcherService DispatcherService
@rendermode InteractiveServer

<h3>Create Dispatcher</h3>

@if (_validationErrors.Any())
{
    <div class="alert alert-danger">
        @foreach (var err in _validationErrors)
        {
            <div>@err</div>
        }
    </div>
}

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert alert-info">@_message</div>
}

<label>First name</label>
<input class="form-control mb-2" @bind="_firstname" />

<label>Last name</label>
<input class="form-control mb-2" @bind="_lastname" />

<label>Email address</label>
<input class="form-control mb-2" @bind="_email" />

<label>Phone number</label>
<input class="form-control mb-2" @bind="_phonenumber" />

<label>Password</label>
<input class="form-control mb-2" type="password" @bind="_password" />

<label>Repeat password</label>
<input class="form-control mb-2" type="password" @bind="_repeatPassword" />

<label>Current rate (%)</label>
<input class="form-control mb-2" type="number" step="0.01" @bind="_currentRate" />

<button class="btn btn-primary" @onclick="RegisterUser">Register</button>

@code {
    private string _firstname = "";
    private string _lastname = "";
    private string _email = "";
    private string _phonenumber = "";
    private string _password = "";
    private string _repeatPassword = "";

    private double _currentRate;

    private string _message = "";
    private List<string> _validationErrors = new();

    private async Task RegisterUser()
    {
        _validationErrors.Clear();
        
        //Validation

        // FIRST NAME
        if (string.IsNullOrWhiteSpace(_firstname))
            _validationErrors.Add("First name is required.");
        else if (_firstname.Length < 3)
            _validationErrors.Add("First name must be at least 3 characters long.");
        else if (!Regex.IsMatch(_firstname, "^[A-Za-z'-]+$"))
            _validationErrors.Add("First name contains invalid characters (allowed: letters, ' and -).");

        // LAST NAME
        if (string.IsNullOrWhiteSpace(_lastname))
            _validationErrors.Add("Last name is required.");
        else if (_lastname.Length < 3)
            _validationErrors.Add("Last name must be at least 3 characters long.");
        else if (!Regex.IsMatch(_lastname, "^[A-Za-z'-]+$"))
            _validationErrors.Add("Last name contains invalid characters (allowed: letters, ' and -).");

        // EMAIL (same regex as backend)
        if (string.IsNullOrWhiteSpace(_email) ||
            !Regex.IsMatch(_email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            _validationErrors.Add("A valid email address is required.");

        // PHONE NUMBER (same as backend)
        if (string.IsNullOrWhiteSpace(_phonenumber))
            _validationErrors.Add("Phone number is required.");
        else if (!Regex.IsMatch(_phonenumber, @"^\+?\d{1,3}([ -]?\d{2,4}){2,5}$"))
            _validationErrors.Add("Phone number format is invalid (example: +49 123 456 789).");

        // PASSWORD (identical rules as backend)
        if (string.IsNullOrWhiteSpace(_password))
            _validationErrors.Add("Password is required.");
        else
        {
            if (_password.Length < 8)
                _validationErrors.Add("Password must be at least 8 characters long.");
            if (_password.Length > 50)
                _validationErrors.Add("Password cannot exceed 50 characters.");
            if (!Regex.IsMatch(_password, @"[A-Z]"))
                _validationErrors.Add("Password must contain at least one uppercase letter.");
            if (!Regex.IsMatch(_password, @"[a-z]"))
                _validationErrors.Add("Password must contain at least one lowercase letter.");
            if (!Regex.IsMatch(_password, @"[0-9]"))
                _validationErrors.Add("Password must contain at least one digit.");
        }
        // REPEAT PASSWORD MATCH
        if (_password != _repeatPassword)
            _validationErrors.Add("Passwords do not match.");


        // CURRENT RATE
        if (_currentRate < 1)
            _validationErrors.Add("Current Rate must be a positive number");

        // If any validation failed
        if (_validationErrors.Any())
            return;


        try
        {
            await DispatcherService.CreateAsync(
                new CreateDispatcherDto(
                    0,
                    _firstname,
                    _lastname,
                    _email,
                    _phonenumber,
                    _currentRate/ 100,
                    _password
                )
            );

            _message = "Dispatcher created successfully!";
        }
        catch (Exception ex)
        {
            _message = $"Error: {ex.Message}";
        }
    }
}
