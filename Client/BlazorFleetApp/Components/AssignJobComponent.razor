@using ApiContracts.Dtos.Dispatcher
@using ApiContracts.Dtos.Driver
@using ApiContracts.Dtos.Job
@using ApiContracts.Enums
@implements IAsyncDisposable
@using BlazorFleetApp.Services.Dispatcher
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using BlazorFleetApp.Services.Hubs
@using BlazorFleetApp.Services.Job
@inject FleetHubClient FleetHub
@inject IDriverService DriverService
@inject IDispatcherService DispatcherService
@inject IJobService JobService

<div class="container-fluid position-relative">
    @if (selectedJob != null)
    {
        <div class="job-overlay" @onclick="ClearSelectedJob"></div>
    }

    <div class="row position-relative" style="z-index: 2;">
        <div class="col-12 select-wrapper">
            <select @onchange="OnJobSelectedObject">
                <option value="">Select Job</option>
                @foreach (var j in unassignedJobs)
                {
                    <option value="@j?.Id">@j?.Title</option>
                }
            </select>
        </div>

        @if (selectedJob != null)
        {
            <div class="col-12 job-details-card fade-in w-100" @onclick:stopPropagation="true">
                <h4>@selectedJob.Title</h4>
                <p>@selectedJob.Description</p>
                <p><strong>Cargo:</strong> @selectedJob.CargoInfo</p>
                <p><strong>Route:</strong> @selectedJob.PickupLocationState → @selectedJob.DropLocationState</p>

                <button class="primary-button" @onclick="AssignJobAsync">Assign Job</button>
                <div class="error-message">@errorMessage</div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public int? InitialDispatcherId { get; set; }
    [Parameter] public DriverDto? InitialDriver { get; set; }
    [Parameter] public DispatcherDto? InitialDispatcher { get; set; }
    [Parameter] public List<JobDto?> InitialJobs { get; set; }
    [Parameter] public JobDto? DriverCurrentJob { get; set; }

    private DriverDto? driver;
    private DispatcherDto? dispatcher;
    private List<JobDto?> jobs = new();
    private List<JobDto?> unassignedJobs = new();
    private JobDto? selectedJob;
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadDriverAsync();
        await LoadDispatcherAsync();
        await LoadJobsAsync();

        // Start FleetHub client
        await FleetHub.StartAsync();

        FleetHub.OnFleetEvent += HandleFleetEvent;

        if (dispatcher?.Id != null)
            await FleetHub.JoinGroupAsync(dispatcher.Id.ToString());
        if (driver?.Id != null)
            await FleetHub.JoinGroupAsync(driver.Id.ToString());
    }

    private async Task HandleFleetEvent(FleetEventType evt)
    {
        // Refresh jobs and driver status whenever relevant event occurs
        if (evt is FleetEventType.JobsUpdated or FleetEventType.JobStatusChanged or FleetEventType.JobAssigned or FleetEventType.DriverStatusChanged)
        {
            await LoadJobsAsync();
            await LoadDriverAsync();

            // Update DriverCurrentJob dynamically
            if (driver != null)
            {
                var currentJob = jobs.FirstOrDefault(j => j?.DriverId == driver.Id);

                // Treat as null if job is denied or status is Available
                DriverCurrentJob = currentJob != null && currentJob.CurrentStatus != JobStatus.Available
                    ? currentJob
                    : null;
            }

            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadDriverAsync()
    {
        driver = InitialDriver ?? (InitialDriverId.HasValue ? await DriverService.GetSingleAsync(InitialDriverId.Value) : null);
    }

    private async Task LoadDispatcherAsync()
    {
        dispatcher = InitialDispatcher ?? (InitialDispatcherId.HasValue ? await DispatcherService.GetSingleAsync(InitialDispatcherId.Value) : null);
    }

    private async Task LoadJobsAsync()
    {
        var allJobs = await JobService.GetAllAsync();
        jobs = allJobs.ToList();
        // Update driver’s current job
        if (driver != null)
        {
            var currentJob = jobs.FirstOrDefault(j => j?.DriverId == driver.Id);
            DriverCurrentJob = currentJob != null && currentJob.CurrentStatus != JobStatus.Available
                ? currentJob
                : null;
        }
        // Filter unassigned jobs for dropdown
        unassignedJobs = jobs
            .Where(j => j != null && j.DriverId == 0 && j.CurrentStatus == JobStatus.Available)
            .ToList();
    }


    private Task OnJobSelectedObject(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
            selectedJob = jobs.FirstOrDefault(x => x?.Id == id);

        return InvokeAsync(StateHasChanged);
    }

    private async Task AssignJobAsync()
    {
        errorMessage = "";

        if (driver == null || dispatcher == null || selectedJob == null)
        {
            errorMessage = "Driver, dispatcher, or job not selected.";
            return;
        }

        driver = await DriverService.GetSingleAsync(driver.Id);
        if (DriverCurrentJob != null || driver.Status != DriverStatus.Available)
        {
            errorMessage = "Driver cannot take this job.";
            return;
        }

        if (selectedJob.TypeOfTrailerNeeded != driver.TrailerType)
        {
            errorMessage = "Driver does not have the required trailer type.";
            return;
        }

        var dto = new UpdateJobDto
        {
            Id = selectedJob.Id,
            DriverId = driver.Id,
            DispatcherId = dispatcher.Id,
            Title = selectedJob.Title,
            Description = selectedJob.Description,
            CargoInfo = selectedJob.CargoInfo,
            PickupLocationState = selectedJob.PickupLocationState,
            PickupLocationZip = selectedJob.PickupLocationZip,
            DropLocationState = selectedJob.DropLocationState,
            DropLocationZip = selectedJob.DropLocationZip,
            TypeOfTrailerNeeded = selectedJob.TypeOfTrailerNeeded,
            DeliveryTime = selectedJob.DeliveryTime,
            LoadedMiles = selectedJob.loadedMiles,
            WeightOfCargo = selectedJob.weightOfCargo,
            TotalPrice = selectedJob.TotalPrice,
            PickupTime = selectedJob.PickupTime,
            CurrentStatus = JobStatus.Assigned
        };

        await JobService.UpdateAsync(dto);
        ClearSelectedJob();

        // Notify groups via FleetHubClient
        await FleetHub.NotifyGroupAsync(driver.Id.ToString(), FleetEventType.JobAssigned);
        await FleetHub.NotifyGroupAsync(dispatcher.Id.ToString(), FleetEventType.JobsUpdated);
        await FleetHub.NotifyGroupAsync(driver.Id.ToString(), FleetEventType.DriversUpdated);

        await InvokeAsync(StateHasChanged);
    }

    private void ClearSelectedJob()
    {
        selectedJob = null;
        errorMessage = string.Empty;
    }

    public async ValueTask DisposeAsync()
    {
        FleetHub.OnFleetEvent -= HandleFleetEvent;

        if (dispatcher?.Id != null)
            await FleetHub.LeaveGroupAsync(dispatcher.Id.ToString());
        if (driver?.Id != null)
            await FleetHub.LeaveGroupAsync(driver.Id.ToString());
    }
}
