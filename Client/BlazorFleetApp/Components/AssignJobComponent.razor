@using ApiContracts.Dtos.Dispatcher
@using ApiContracts.Dtos.Driver
@using ApiContracts.Dtos.Job
@using ApiContracts.Enums
@using BlazorFleetApp.Services.Dispatcher
@using BlazorFleetApp.Services.Job
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavMgr
@inject IDriverService DriverService
@inject IDispatcherService DispatcherService
@inject IJobService JobService
@implements IAsyncDisposable

<div class="container-fluid">
    <div class="row">
        <div class="col-12 select-wrapper">
            <select @onchange="OnJobSelectedObject">
                <option value="">Select Job</option>
                @foreach (var j in jobs)
                {
                    if (j != null)
                    {
                        <option value="@j.Id">@j.Title</option>
                    }
                }
            </select>
        </div>
        @if (selectedJob != null)
        {
            <div class=" col-12 job-details-card fade-in w-100">
                <h4>@selectedJob.Title</h4>

                <p>@selectedJob.Description</p>
                <p><strong>Cargo:</strong> @selectedJob.CargoInfo</p>

                <p>
                    <strong>Route:</strong>
                    @selectedJob.PickupLocationState â†’ @selectedJob.DropLocationState
                </p>

                <button class="primary-button" @onclick="AssignJobAsync">Assign
                    Job
                </button>

                <div class="error-message">@errorMessage</div>
                <div class="error-message">@message</div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public int? InitialDispatcherId { get; set; }
    [Parameter] public DriverDto? InitialDriver { get; set; }
    [Parameter] public DispatcherDto? InitialDispatcher { get; set; }
    [Parameter] public List<JobDto?> InitialJobs { get; set; }
    private DriverDto? driver;
    private List<JobDto?> jobs = new List<JobDto?>();
    private DispatcherDto? dispatcher;
    private string errorMessage = "";
    private string message = "";
    private JobDto? selectedJob;
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadDriverAsync();
        await LoadDispatcherAsync();
        await LoadJobsAsync();
        await SetupHubAsync();
    }

    private async Task SetupHubAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavMgr.ToAbsoluteUri("/fleethub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<FleetEventType>("FleetEvent", (eventType) =>
        {
            return InvokeAsync(async () =>
            {
                if (eventType == FleetEventType.DriverStatusChanged ||
                    eventType == FleetEventType.DriversUpdated)
                {
                    // Fetch latest driver status
                    if (driver?.Id != null)
                        driver = await DriverService.GetSingleAsync(driver.Id);

                    await StateHasChangedAsyncSafely();
                }

                if (eventType == FleetEventType.JobAssigned || eventType == FleetEventType.JobsUpdated)
                {
                    // Optionally refresh jobs
                    jobs = InitialJobs; // or fetch latest from DB
                    if (selectedJob != null)
                    {
                        selectedJob = jobs.FirstOrDefault(j => j?.Id == selectedJob.Id);
                    }

                    await StateHasChangedAsyncSafely();
                }
            });
        });


        await hubConnection.StartAsync();

        // Join dispatcher group
        var groupId = dispatcher?.Id.ToString();
        if (groupId != null)
            await hubConnection.InvokeAsync("JoinGroup", groupId);
    }

    private async Task LoadDriverAsync()
    {
        if (InitialDriverId != null) driver = await DriverService.GetSingleAsync((int)InitialDriverId);
        else if (InitialDriver != null) driver = InitialDriver;
    }

    private async Task LoadDispatcherAsync()
    {
        if (InitialDispatcherId != null) dispatcher = await DispatcherService.GetSingleAsync((int)InitialDispatcherId);
        else if (InitialDispatcher != null) dispatcher = InitialDispatcher;
    }

    private Task LoadJobsAsync()
    {
        jobs = InitialJobs ?? new List<JobDto?>();
        return Task.CompletedTask;
    }




    private Task OnJobSelectedObject(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedJob = jobs.FirstOrDefault(x => x?.Id == id);
        }

        return InvokeAsync(StateHasChanged);
    }

    private async Task AssignJobAsync()
{
    if (driver == null)
    {
        errorMessage = "Driver not loaded.";
        return;
    }

    // Refresh the latest status from DB
    driver = await DriverService.GetSingleAsync(driver.Id);

    if (driver.Status != DriverStatus.Available)
    {
        errorMessage = "Cannot assign a job to a busy or off duty driver";
        return;
    }

    if (selectedJob == null)
    {
        errorMessage = "No job selected.";
        return;
    }

    try
    {
        var dto = new UpdateJobDto
        {
            Title = selectedJob.Title,
            CargoInfo = selectedJob.CargoInfo,
            CurrentStatus = JobStatus.Assigned,
            DeliveryTime = selectedJob.DeliveryTime,
            Description = selectedJob.Description,
            DispatcherId = selectedJob.DispatcherId,
            DriverId = driver.Id,
            DropLocationState = selectedJob.DropLocationState,
            DropLocationZip = selectedJob.DropLocationZip,
            Id = selectedJob.Id,
            LoadedMiles = selectedJob.loadedMiles,
            WeightOfCargo = selectedJob.weightOfCargo,
            TypeOfTrailerNeeded = selectedJob.TypeOfTrailerNeeded,
            TotalPrice = selectedJob.TotalPrice,
            PickupTime = selectedJob.PickupTime,
            PickupLocationZip = selectedJob.PickupLocationZip,
            PickupLocationState = selectedJob.PickupLocationState,
        };

        await JobService.UpdateAsync(dto);
        await ChangeStatusAsync(DriverStatus.Busy);

        message = "Job has been assigned successfully";
        selectedJob = null;
        errorMessage = "";
        if (hubConnection != null)
        {
            await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.DriversUpdated);
            await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.JobsUpdated);
            await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.JobAssigned);
        }
    }
    catch (Exception e)
    {
        errorMessage = e.Message;
    }
}


    private async Task ChangeStatusAsync(DriverStatus newStatus)
    {
        if (driver == null) return;
        driver = await DriverService.GetSingleAsync(driver.Id);
        if (driver != null)
        {
            driver = driver with { Status = newStatus };
            await DriverService.UpdateAsync(driver);
        }

        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null && dispatcher != null)
        {
            await hubConnection.InvokeAsync("LeaveGroup", dispatcher.Id.ToString());
            await hubConnection.DisposeAsync();
        }
    }

    private Task StateHasChangedAsyncSafely()
    {
        return InvokeAsync(StateHasChanged);
    }

}