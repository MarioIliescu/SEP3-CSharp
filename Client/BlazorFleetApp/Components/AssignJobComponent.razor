@using ApiContracts.Dtos.Dispatcher
@using ApiContracts.Dtos.Driver
@using ApiContracts.Dtos.Job
@using ApiContracts.Enums
@using BlazorFleetApp.Services.Dispatcher
@using BlazorFleetApp.Services.Job
@using BlazorFleetApp.Services.Driver
@using BlazorFleetApp.Services.Events
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavMgr
@inject IDriverService DriverService
@inject IDispatcherService DispatcherService
@inject IJobService JobService
@implements IAsyncDisposable
<div class="container-fluid position-relative">

    @if (selectedJob != null)
    {
        <div class="job-overlay" @onclick="ClearSelectedJob"></div>
    }

    <div class="row position-relative" style="z-index: 2;">
        <div class="col-12 select-wrapper">
            <select @onchange="OnJobSelectedObject">
                <option value="">Select Job</option>
                @foreach (var j in jobs)
                {
                    if (j != null)
                    {
                        <option value="@j.Id">@j.Title</option>
                    }
                }
            </select>
        </div>

        @if (selectedJob != null)
        {
            <div class="col-12 job-details-card fade-in w-100"
                 @onclick:stopPropagation="true">
                <h4>@selectedJob.Title</h4>

                <p>@selectedJob.Description</p>
                <p><strong>Cargo:</strong> @selectedJob.CargoInfo</p>

                <p>
                    <strong>Route:</strong>
                    @selectedJob.PickupLocationState â†’ @selectedJob.DropLocationState
                </p>

                <button class="primary-button" @onclick="AssignJobAsync">
                    Assign Job
                </button>

                <div class="error-message">@errorMessage</div>
            </div>
        }
    </div>
</div>

@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    [Parameter] public int? InitialDriverId { get; set; }
    [Parameter] public int? InitialDispatcherId { get; set; }
    [Parameter] public DriverDto? InitialDriver { get; set; }
    [Parameter] public DispatcherDto? InitialDispatcher { get; set; }
    [Parameter] public List<JobDto?> InitialJobs { get; set; }
    [Parameter] public JobDto? DriverCurrentJob { get; set; }
    private DriverDto? driver;
    private List<JobDto?> jobs = new List<JobDto?>();
    private DispatcherDto? dispatcher;
    private string errorMessage = "";
    private JobDto? selectedJob;
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadDriverAsync();
        await LoadDispatcherAsync();
        await LoadJobsAsync();
        await SetupHubAsync();
    }

    private async Task SetupHubAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavMgr.ToAbsoluteUri("/fleethub"), options =>
            {
                options.AccessTokenProvider = async () =>
                {
                    var authState = await State;
                    var user = authState.User;
                    return user?.Claims.FirstOrDefault(c => c.Type == "access_token")?.Value;
                };
            })
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<FleetEventType>("FleetEvent", async (eventType) =>
        {
            if (eventType is
                FleetEventType.JobsUpdated
                or FleetEventType.JobStatusChanged
                or FleetEventType.JobAssigned
                or FleetEventType.DriverStatusChanged
                or FleetEventType.DriversUpdated
                )
            {
                    await RefreshDataAsync();
            }
        });


        await hubConnection.StartAsync();

        // Join dispatcher group
        var groupId = dispatcher?.Id.ToString();
        if (groupId != null)
            await hubConnection.InvokeAsync("JoinGroup", groupId);
    }
    private async Task RefreshDataAsync()
    {
        await LoadJobsAsync();
        await LoadDriverAsync();
        await LoadDispatcherAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadDriverAsync()
    {
        if (InitialDriverId != null) driver = await DriverService.GetSingleAsync((int)InitialDriverId);
        else if (InitialDriver != null) driver = InitialDriver;
    }

    private async Task LoadDispatcherAsync()
    {
        if (InitialDispatcherId != null) dispatcher = await DispatcherService.GetSingleAsync((int)InitialDispatcherId);
        else if (InitialDispatcher != null) dispatcher = InitialDispatcher;
    }

    private async Task LoadJobsAsync()
    {
        var jobsData = await JobService.GetAllAsync();
        jobs = jobsData.Where(dto => dto is { DriverId: 0, CurrentStatus: JobStatus.Available }).ToList()!;
    }




    private Task OnJobSelectedObject(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            selectedJob = jobs.FirstOrDefault(x => x?.Id == id);
        }

        return InvokeAsync(StateHasChanged);
    }

    private async Task AssignJobAsync()
    {
        if (driver == null || driver.Id == 0)
        {
            errorMessage = "Cannot assign job: driver not selected or invalid.";
            return;
        }
        if (dispatcher == null || dispatcher.Id == 0)
        {
            errorMessage = "Dispatcher not loaded.";
            return;
        }

        if (selectedJob == null)
        {
            errorMessage = "No job selected.";
            return;
        }

        driver = await DriverService.GetSingleAsync(driver.Id);
        if (DriverCurrentJob != null)
        {
            errorMessage = "Cannot assign a job when another job is already ongoing";
            return;
        }

        if (driver?.Status != DriverStatus.Available)
        {
            errorMessage = "Cannot assign a job to a busy or off duty driver";
            return;
        }

        if (selectedJob.TypeOfTrailerNeeded != driver.TrailerType)
        {
            errorMessage = "The driver does not have the trailer type needed for the job";
            return;

        }

        try
        {
            var dto = new UpdateJobDto
            {
                Title = selectedJob.Title,
                CargoInfo = selectedJob.CargoInfo,
                CurrentStatus = JobStatus.Assigned,
                DeliveryTime = selectedJob.DeliveryTime,
                Description = selectedJob.Description,
                DispatcherId = dispatcher.Id,
                DriverId = driver.Id,
                DropLocationState = selectedJob.DropLocationState,
                DropLocationZip = selectedJob.DropLocationZip,
                Id = selectedJob.Id,
                LoadedMiles = selectedJob.loadedMiles,
                WeightOfCargo = selectedJob.weightOfCargo,
                TypeOfTrailerNeeded = selectedJob.TypeOfTrailerNeeded,
                TotalPrice = selectedJob.TotalPrice,
                PickupTime = selectedJob.PickupTime,
                PickupLocationZip = selectedJob.PickupLocationZip,
                PickupLocationState = selectedJob.PickupLocationState,
            };

            await JobService.UpdateAsync(dto);
            ClearSelectedJob();
            if (hubConnection != null)
            {
                await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.DriversUpdated);
                await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.JobsUpdated);
                await hubConnection.InvokeAsync("NotifyEvent", FleetEventType.JobAssigned); ;
            }

            await InvokeAsync(StateHasChanged);
        }
        catch (Exception e)
        {
            errorMessage = e.Message;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null && dispatcher != null)
        {
            await hubConnection.InvokeAsync("LeaveGroup", dispatcher.Id.ToString());
            await hubConnection.DisposeAsync();
        }
    }

    private void ClearSelectedJob()
    {
        selectedJob = null;
        errorMessage = string.Empty;
    }


}